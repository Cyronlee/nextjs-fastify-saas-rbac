{"version":3,"sources":["../../src/utils/generate-avatar.ts","../../src/errors/messages.ts","../../src/http/routes/_errors/bad-request-error.ts","../../src/utils/generate-filename.ts"],"sourcesContent":["/* eslint-disable prettier/prettier */\nimport { randomUUID } from 'node:crypto'\n\nimport { MultipartFile } from '@fastify/multipart'\nimport { FastifyInstance } from 'fastify'\nimport sharp from 'sharp'\n\nimport { errors } from '@/errors/messages'\nimport { BadRequestError } from '@/http/routes/_errors/bad-request-error'\n\nimport { generateFilename } from './generate-filename'\n\nexport async function generateAvatar(\n\tapp: FastifyInstance,\n\tfile?: MultipartFile,\n) {\n\tif (!file) {\n\t\tthrow new BadRequestError(errors.files.NOT_FOUND)\n\t}\n\n\tlet fileBuffer: Buffer\n\n\ttry {\n\t\tfileBuffer = await file.toBuffer()\n\t} catch (error) {\n\t\tif (error instanceof app.multipartErrors.RequestFileTooLargeError) {\n\t\t\tthrow new BadRequestError(errors.files.MAX_SIZE)\n\t\t}\n\n\t\tconsole.log(error)\n\n\t\tthrow new BadRequestError(errors.files.PROCESSING)\n\t}\n\n\tconst fileName = file.filename\n\tconst fileMimeType = file.mimetype\n\n\tif (!/^image\\/(jpeg|png)$/.test(fileMimeType)) {\n\t\tthrow new BadRequestError(errors.files.FORMAT)\n\t}\n\n\tconst fileNamePrefix = randomUUID()\n\tconst uniqueFileName = generateFilename(`${fileNamePrefix}-${fileName}`)\n\n\tlet transformedBuffer: Buffer\n\n\ttry {\n\t\ttransformedBuffer = await sharp(fileBuffer)\n\t\t\t.resize(600, 600)\n\t\t\t.jpeg()\n\t\t\t.toBuffer()\n\t} catch (error) {\n\t\tconsole.log(error)\n\n\t\tthrow new BadRequestError(errors.files.PROCESSING)\n\t}\n\n\treturn {\n\t\tfileName: uniqueFileName,\n\t\tmimeType: 'image/jpeg', // fileMimeType fixed since its converted\n\t\tfileBuffer: transformedBuffer,\n\t}\n}\n","/* eslint-disable prettier/prettier */\nexport const errors = {\n\tapi: {\n\t\tVALIDATION_ERROR: 'Validation error',\n\t\tSERVER_ERROR: 'Internal server error',\n\t},\n\tservices: {\n\t\tSEND_EMAIL: 'An error occurred while trying to send the e-mail',\n\t\tGITHUB_ALREADY_CONNECTED: 'You already have a GitHub account connected',\n\t\tGITHUB_ALREADY_CONNECTED_SOMEONE_ELSE: 'This Github account is already connected with another account',\n\t\tGOOGLE_ALREADY_CONNECTED: 'You already have a Google account connected',\n\t\tGOOGLE_ALREADY_CONNECTED_SOMEONE_ELSE: 'This Google account is already connected with another account',\n\t},\n\tuser: {\n\t\tALREADY_EXISTS: 'An user with same e-mail already exists',\n\t\tNOT_FOUND: 'User not found',\n\t\tACCOUNT_NOT_FOUND: 'Account not found',\n\t\tEMAIL_VALIDATION_NOT_FOUND: 'E-mail change validation not found',\n\t\tEMAIL_VALIDATION_EXPIRED: 'E-mail change validation does not exists or already expired',\n\t\tEMAIL_VALIDATION_INVALID: 'Invalid validation code'\n\t},\n\tauth: {\n\t\tNOT_PASSWORD_FOUND: 'User does not have a password, use social sign-in',\n\t\tINVALID_CREDENTIALS: 'Invalid credentials',\n\t\tINVALID_TOKEN: 'Invalid authentication token',\n\t\tINVALID_EMAIL_TOKEN: 'The token provied is not valid. Note: The code is valid for 5 minutes',\n\t\tINVALID_PASSWORD_TOKEN: 'Unable to reset password. Ensure your recovery code is valid and try again. Note: The code is valid for 5 minutes',\n\t\tLAST_METHOD_AVAILABLE: 'This service is the only access method available. Set a password or connect with another provider first',\n\t\tGITHUB_EMAIL_NOT_FOUND: 'Your GitHub account does not have an e-mail to authenticate',\n\t\tPASSWORD_NUMBER: 'Enter one number.',\n\t\tPASSWORD_UPPER: 'Enter one upper case letter.',\n\t\tPASSWORD_LOWER: 'Enter one lower case letter.',\n\t\tPASSWORD_SPECIAL: 'Enter one special character.',\n\t\tPASSWORD_LENGTH: 'Enter at least 6 characters.',\n\t},\n\torganizations: {\n\t\tentity: {\n\t\t\tNOT_FOUND: 'Organization not found',\n\t\t\tNOT_MEMBER: 'The user is not a member of this organization',\n\t\t\tALREADY_EXISTS: 'There is another organization using the same name. Choose a different one',\n\t\t\tCANNOT_SHUTDOWN: 'You are not allowed to shutdown this organization',\n\t\t\tCANNOT_TRANSFER: 'You are not allowed to transfer ownership of this organization',\n\t\t\tCANNOT_UPDATE: 'You are not allowed to update this organization',\n\t\t\tCANNOT_LEAVE: 'You are the owner of this organization, to leave it you must transfer the ownership first',\n\t\t},\n\t\tbilling: {\n\t\t\tCANNOT_LIST: 'You are not allowed to get billing details from this organization',\n\t\t},\n\t\tdomain: {\n\t\t\tALREADY_EXISTS: 'Another organization with same domain already exists',\n\t\t\tCHECK_DNS: 'Error checking DNS information',\n\t\t\tTXT_NOT_FOUND: 'A valid TXT record was not found in the DNS records',\n\t\t\tTXT_INVALID: 'A valid TXT record was found, but does not match in the DNS records. Check your DNS values.',\n\t\t},\n\t\tmembers: {\n\t\t\tCANNOT_ACCESS: 'You are not a member of this organization',\n\t\t\tCANNOT_LIST: 'You are not allowed to list organization members',\n\t\t\tCANNOT_DELETE: 'You are not allowed to remove this organization member',\n\t\t\tCANNOT_UPDATE: 'You are not allowed to update this organization member',\n\t\t},\n\t\tinvites: {\n\t\t\tNOT_FOUND: 'Invite not found or expired',\n\t\t\tNOT_ALLOWED: 'This invite belongs to another user',\n\t\t\tAUTOJOIN_DOMAIN: 'Users with {domain} domain will join your organization automatically on sign in',\n\t\t\tALREADY_EXISTS: 'Another invite with same e-mail already exists',\n\t\t\tALREADY_MEMBER: 'A member with this e-mail already belongs to your organization',\n\t\t\tCANNOT_SEND: 'You are not allowed to create a new invite',\n\t\t\tCANNOT_LIST: 'You are not allowed to get organization invites',\n\t\t\tCANNOT_REVOKE: 'You are not allowed to revoke an invite',\n\t\t},\n\t},\n\tprojects: {\n\t\tNOT_FOUND: 'Project not found',\n\t\tALREADY_EXISTS: 'There is another project in this organization using the same project name. Choose a different one',\n\t\tCANNOT_LIST: 'You are not allowed to list projects',\n\t\tCANNOT_GET: 'You are not allowed to get a project',\n\t\tCANNOT_CREATE: 'You are not allowed to create a new project',\n\t\tCANNOT_UPDATE: 'You are not allowed to update this project',\n\t\tCANNOT_DELETE: 'You are not allowed to remove this project',\n\t},\n\tfiles: {\n\t\tNOT_FOUND: 'Select a file to update',\n\t\tMAX_SIZE: 'Your avatar must have less than 2mb',\n\t\tPROCESSING: 'An unexpected error occurred while processing your file', \n\t\tFORMAT: 'The file selected is not a valid image',\n\t\tUPLOAD: 'An unexpected error occurred during file upload',\n\t\tDELETE: 'An unexpected error occurred during file removal',\n\t}\n}\n","export class BadRequestError extends Error {}\n","export function generateFilename(filename: string) {\n\tconst parts = filename.split('.')\n\tconst extension = parts.pop()?.toLocaleLowerCase()\n\tconst name = parts.join('.')\n\n\tconst slug = name\n\t\t.toLowerCase()\n\t\t.trim()\n\t\t.replace(/[^a-z0-9]+/g, '-')\n\t\t.replace(/^-+|-+$/g, '')\n\n\treturn extension ? `${slug}.${extension}` : slug\n}\n"],"mappings":"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","names":["sharp"]}